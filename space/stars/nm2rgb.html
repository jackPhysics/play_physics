<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Hex Colour Square</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    #controls { margin-top: 10px; }
    input[type=text] { width: 60px; font-family: monospace; text-align: center; }
    label { margin-right: 10px; }
  </style>
</head>
<body>
  <canvas id="colorCanvas" width="300" height="300"></canvas>

  <div id="controls">
    <p id="colorCode"></p>
    <label>wavelength: <input type="text" id="hexR" maxlength="3" value="555"> nm</label>
  </div>

  <script>
    (function () {
      const canvas = document.getElementById('colorCanvas');
      const ctx = canvas.getContext('2d');
      const inputs = ['hexR'].map(id => document.getElementById(id));
      var wavelength = 555;
      var redN = 0;
      var greenN = 0;
      var blueN = 0;

      function sanitize(value) {
        // Ensure the string starts with an optional '#' followed by up to two hex digits
        const match = value.match(/^#?([0-9a-fA-F]{0,2})$/);
        if (!match) return '00';
        return match[1].padEnd(2, '0').toUpperCase();
      }

      function updateColor() {
	//console.log("1: "+document.getElementById('hexR').value)
        const parts = inputs.map(el => sanitize(el.value));
        const colour = '#' + parts.join('');
	//console.log("2: "+inputs)
        draw(colour);
      }

      function calculateColor(){
	//find RED
	wavelength = document.getElementById('hexR').value;
	//console.log("1w="+wavelength);
	if(wavelength<440){
	 var w = wavelength;
		redN = Math.round(-0.086456*w*w + 69.359*w - 13778);
	}
	else if(wavelength<510){
		redN = 0;
	}
	else if(wavelength<580){
	 var w = wavelength;
		redN = Math.round(-0.014573*w*w + 19.398*w - 6094);
	}
	else if(wavelength<644){
		redN = 255;
	}
	else{
	 var w = wavelength;
		redN = Math.floor(-0.00064*w*w - 0.0192*w + 532.93);
	}
	if(redN<0){redN=0;}
	if(redN>255){redN=255;}
	//console.log("colorR="+redN);

       //find BLUE
	//wavelength = +document.getElementById('hexR').value;
	if(wavelength<420){
	 var w = wavelength;
		blueN = Math.round(-0.01251*w*w + 13.945*w - 3395.4);
	}
	else if(wavelength<490){
		blueN = 255;
	}
	else if(wavelength<510){
	 var w = wavelength;
		blueN = Math.round(-0.19713*w*w + 184.56*w - 42848);
	}
	else{
	 var w = wavelength;
		blueN = 0;
	}
	if(blueN<0){blueN=0;}
	if(blueN>255){blueN=255;}
	//console.log("colorB="+blueN);
	
	//find GREEN
	//wavelength = +document.getElementById('hexR').value;
	if(wavelength<440){
	 var w = wavelength;
		greenN = 0;
	}
	else if(wavelength<490){
	 var w = wavelength;
		greenN = Math.round(-0.02964*w*w + 32.513*w - 8560.1);
	//console.log("w="+wavelength+" colorG="+greenN);
	}
	else if(wavelength<580){
	 var w = wavelength;
		greenN = 255;
	}
	else{
	 var w = wavelength;
		greenN = Math.round(-0.01697*w*w + 17.015*w - 3905.1);
	}
	if(greenN<0){greenN=0;}
	if(greenN>255){greenN=255;}
	//console.log("colorG="+greenN);
	}

      function draw(colour) {
        ctx.fillStyle = colour;
        ctx.fillRect(0, 0, canvas.width, canvas.height);
      }

      inputs.forEach(el => {
        el.addEventListener('input', calculateColor);//,updateColor)
        el.addEventListener('blur', () => {
          // Standardize input format on blur
	var redHex = redN.toString(16);
	//console.log(""+redHex);
	if(redHex.length<2){redHex = "0"+redHex;}
	var greenHex = greenN.toString(16);
	//console.log(""+greenHex);
	if(greenHex.length<2){greenHex = "0"+greenHex;}
	var blueHex = blueN.toString(16);
	//console.log(""+blueHex);
	if(blueHex.length<2){blueHex = "0"+blueHex;}
	var newColorH = '#' + redHex + greenHex + blueHex;
	//console.log(""+newColorH);
          //el.value = newColorH;//sanitize(el.value);
	draw(newColorH);
	document.getElementById('colorCode').innerHTML=""+wavelength+" nm = "+newColorH;
        });
      });

	[hexR].forEach((el, idx) => {
 	 //const ctx = idx === 0 ? ctx;

	  el.addEventListener('keydown', event => {
	    if (event.key === 'Enter') {
	      event.preventDefault(); // Optional: prevents form submission if in a form
 	     //el.value = '#' + sanitize6(el.value);
 	     //updateSideColor(el, ctx);
	calculateColor();
	var redHex = redN.toString(16);
	if(redHex.length<2){redHex = "0"+redHex;}
	var greenHex = greenN.toString(16);
	if(greenHex.length<2){greenHex = "0"+greenHex;}
	var blueHex = blueN.toString(16);
	if(blueHex.length<2){blueHex = "0"+blueHex;}
	var newColorH = '#' + redHex + greenHex + blueHex;
	draw(newColorH);
	document.getElementById('colorCode').innerHTML=""+wavelength+" nm = "+newColorH.toUpperCase();
 	   }
	  });
	});

      // Initial draw (555nm)
      draw('#b7ff00');
      document.getElementById('hexR').value = "555";
      document.getElementById('colorCode').innerHTML="555 nm = #B7FF00";
    })();
  </script>
</body>
</html>
